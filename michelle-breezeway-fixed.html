<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Breezeway ‚Üí Michelle</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');

  :root {
    --bg: #0a0a0f; --card: #111118; --card2: #18181f; --border: #252530;
    --accent: #4fffb0; --accent-glow: rgba(79,255,176,0.12);
    --text: #eeeef5; --muted: #55556a; --red: #ff4f6d; --yellow: #ffd16e; --r: 14px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: 'Space Grotesk', sans-serif; min-height: 100vh; padding-bottom: 80px; }

  .header {
    background: linear-gradient(135deg, #0d1117 0%, #111820 100%);
    border-bottom: 1px solid var(--border); padding: 28px 20px 22px;
    text-align: center; position: relative; overflow: hidden;
  }
  .header::before {
    content: ''; position: absolute; top: -60px; left: 50%; transform: translateX(-50%);
    width: 300px; height: 140px;
    background: radial-gradient(ellipse, rgba(79,255,176,0.1) 0%, transparent 70%);
    pointer-events: none;
  }
  .header .eyebrow { font-family: 'JetBrains Mono', monospace; font-size: 10px; letter-spacing: 3px; color: var(--accent); text-transform: uppercase; margin-bottom: 8px; }
  .header h1 { font-size: 24px; font-weight: 700; letter-spacing: -0.5px; }
  .header h1 span { color: var(--accent); }
  .header p { font-size: 13px; color: var(--muted); margin-top: 5px; }

  .steps { display: flex; margin: 20px 16px 0; }
  .step { flex: 1; text-align: center; padding: 10px 6px; background: var(--card); border: 1px solid var(--border); }
  .step:first-child { border-radius: var(--r) 0 0 var(--r); }
  .step:last-child  { border-radius: 0 var(--r) var(--r) 0; }
  .step.active { background: var(--accent-glow); border-color: var(--accent); }
  .step.done   { border-color: var(--accent); }
  .step .num   { font-family: 'JetBrains Mono', monospace; font-size: 9px; color: var(--muted); display: block; margin-bottom: 2px; }
  .step.active .num, .step.done .num { color: var(--accent); }
  .step .lbl   { font-size: 11px; font-weight: 500; }

  /* UPLOAD ZONE */
  .upload-zone {
    margin: 20px 16px 0; border: 2px dashed var(--border); border-radius: var(--r);
    padding: 34px 20px; text-align: center; cursor: pointer;
    background: var(--card); position: relative; transition: all 0.2s;
  }
  .upload-zone:hover, .upload-zone.drag { border-color: var(--accent); background: var(--accent-glow); }
  /* Input invisible pero ocupa todo el √°rea - sin restrict accept para iOS */
  .upload-zone input {
    position: absolute; inset: 0; opacity: 0; cursor: pointer;
    width: 100%; height: 100%;
    font-size: 16px; /* Previene zoom autom√°tico en iOS */
  }
  .upload-zone .ico { font-size: 34px; margin-bottom: 10px; }
  .upload-zone h3  { font-size: 15px; font-weight: 600; margin-bottom: 5px; }
  .upload-zone p   { font-size: 12px; color: var(--muted); }
  .upload-zone .ios-tip {
    font-size: 11px; color: var(--yellow); margin-top: 10px;
    background: rgba(255,209,110,0.08); padding: 6px 10px; border-radius: 8px;
  }

  /* Bot√≥n alternativo grande - m√°s confiable en iOS Safari */
  .ios-file-btn {
    display: flex; align-items: center; justify-content: center; gap: 10px;
    width: calc(100% - 32px); margin: 10px 16px 0;
    padding: 15px; background: var(--card2); border: 1.5px solid var(--accent);
    color: var(--accent); border-radius: var(--r); font-size: 14px; font-weight: 600;
    cursor: pointer; font-family: 'Space Grotesk', sans-serif;
    position: relative; overflow: hidden; transition: background 0.2s;
  }
  .ios-file-btn:active { background: var(--accent-glow); }
  .ios-file-btn input {
    position: absolute; inset: 0; opacity: 0; cursor: pointer;
    width: 100%; height: 100%;
    font-size: 16px; /* Previene zoom iOS */
  }

  .skip-btn {
    display: block; width: calc(100% - 32px); margin: 12px 16px 0;
    padding: 12px; background: var(--card2); border: 1px solid var(--border);
    color: var(--muted); border-radius: var(--r); font-size: 13px;
    cursor: pointer; transition: all 0.2s; text-align: center;
  }
  .skip-btn:hover { border-color: var(--accent); color: var(--accent); }

  .content { padding: 0 16px; }

  .status-bar {
    display: none; margin-top: 14px; background: var(--card); border: 1px solid var(--border);
    border-radius: var(--r); padding: 12px 16px; font-size: 13px; color: var(--muted);
    font-family: 'JetBrains Mono', monospace; align-items: center; gap: 10px;
  }
  .status-bar.show { display: flex; }
  .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent); flex-shrink: 0; animation: pulse 1.5s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.3} }

  .info-box {
    margin-top: 14px; background: rgba(79,143,255,0.08); border: 1px solid rgba(79,143,255,0.3);
    border-radius: var(--r); padding: 12px 16px; font-size: 12px; line-height: 1.6; color: #8fb3ff;
  }
  .info-box strong { color: #4f8fff; }

  .holiday-alert {
    display: none; margin-top: 14px;
    background: rgba(255,209,110,0.1); border: 1px solid rgba(255,209,110,0.4);
    border-radius: var(--r); padding: 12px 16px; align-items: flex-start; gap: 10px;
  }
  .holiday-alert.show { display: flex; }
  .holiday-alert .ico { font-size: 18px; flex-shrink: 0; }
  .holiday-alert .title { font-size: 13px; font-weight: 600; color: var(--yellow); margin-bottom: 3px; }
  .holiday-alert .dates { font-family: 'JetBrains Mono', monospace; font-size: 11px; color: rgba(255,209,110,0.7); }

  .sec-label {
    font-family: 'JetBrains Mono', monospace; font-size: 10px; letter-spacing: 2px;
    color: var(--accent); text-transform: uppercase; margin: 22px 0 10px;
    display: flex; align-items: center; gap: 8px;
  }
  .sec-label::after { content:''; flex:1; height:1px; background: var(--border); }

  .pay-section { display: none; }
  .pay-section.show { display: block; }
  .hint { font-size: 12px; color: var(--muted); margin-bottom: 12px; line-height: 1.6; }

  .day-pay-grid { display: grid; gap: 8px; }
  .day-pay-row {
    background: var(--card); border: 1px solid var(--border);
    border-radius: 10px; padding: 10px 14px;
    display: flex; align-items: center; gap: 8px; flex-wrap: wrap;
  }
  .day-pay-row.has-holiday { border-color: rgba(255,209,110,0.35); }
  .day-info { flex: 1; min-width: 0; }
  .day-pay-name { font-size: 13px; font-weight: 600; }
  .day-pay-units { font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--muted); margin-top: 2px; }
  .day-pay-amount { font-family: 'JetBrains Mono', monospace; font-size: 14px; color: var(--accent); font-weight: 600; flex-shrink: 0; }
  .holiday-badge { font-size: 9px; background: rgba(255,209,110,0.15); color: var(--yellow); padding: 1px 6px; border-radius: 4px; font-weight: 600; margin-left: 5px; }
  .today-badge { font-size: 9px; background: var(--accent); color: #000; padding: 1px 6px; border-radius: 4px; font-weight: 700; margin-left: 5px; text-transform: uppercase; }

  .pay-status-toggle { display: flex; border-radius: 8px; overflow: hidden; border: 1px solid var(--border); flex-shrink: 0; }
  .pay-status-toggle button {
    background: none; border: none; padding: 6px 10px; font-size: 11px; cursor: pointer;
    color: var(--muted); font-family: 'Space Grotesk', sans-serif; font-weight: 500; transition: all 0.15s;
  }
  .pay-status-toggle button.active-pend { background: rgba(255,209,110,0.15); color: var(--yellow); }
  .pay-status-toggle button.active-paid { background: var(--accent-glow); color: var(--accent); }

  .paid-date-input {
    background: var(--card2); border: 1px solid var(--border); color: var(--text);
    padding: 6px 9px; border-radius: 6px; font-family: 'JetBrains Mono', monospace;
    font-size: 11px; width: 78px; display: none;
  }
  .paid-date-input.show { display: block; }
  .paid-date-input:focus { outline: none; border-color: var(--accent); }

  .totals-box { background: var(--card); border: 1px solid var(--border); border-radius: var(--r); padding: 14px 16px; margin-top: 12px; }
  .total-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid var(--border); font-size: 13px; }
  .total-row:last-child { border-bottom: none; }
  .total-row .tl { color: var(--muted); }
  .total-row .tr { font-family: 'JetBrains Mono', monospace; font-weight: 600; }
  .total-row.highlight .tr { color: var(--accent); font-size: 16px; }

  .prev-pay-row { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; }
  .prev-pay-row input {
    background: var(--card2); border: 1px solid var(--border); color: var(--text);
    padding: 8px 10px; border-radius: 8px; font-family: 'JetBrains Mono', monospace;
    font-size: 12px; transition: border-color 0.2s;
  }
  .prev-pay-row input:focus { outline: none; border-color: var(--accent); }
  .prev-pay-row .date-in { width: 90px; }
  .prev-pay-row .amt-in  { width: 80px; }
  .remove-btn { background: none; border: none; color: var(--muted); font-size: 20px; cursor: pointer; padding: 4px; border-radius: 6px; line-height: 1; transition: color 0.2s; flex-shrink: 0; }
  .remove-btn:hover { color: var(--red); }
  .add-prev-btn {
    display: flex; align-items: center; gap: 6px;
    background: var(--accent-glow); border: 1px dashed var(--accent);
    color: var(--accent); font-size: 12px; font-weight: 500;
    padding: 8px 14px; border-radius: 8px; cursor: pointer;
    width: 100%; justify-content: center; margin-top: 4px;
    font-family: 'Space Grotesk', sans-serif; transition: background 0.2s;
  }
  .add-prev-btn:hover { background: rgba(79,255,176,0.2); }

  .gen-btn {
    width: 100%; padding: 16px; background: var(--accent); color: #000;
    border: none; border-radius: var(--r); font-family: 'Space Grotesk', sans-serif;
    font-size: 15px; font-weight: 700; cursor: pointer; margin-top: 22px;
    box-shadow: 0 0 24px rgba(79,255,176,0.2); transition: opacity 0.2s, transform 0.1s;
  }
  .gen-btn:hover { opacity: 0.9; }
  .gen-btn:active { transform: scale(0.98); }

  .output-section { display: none; margin-top: 24px; }
  .output-section.show { display: block; }
  .out-label { font-family: 'JetBrains Mono', monospace; font-size: 10px; letter-spacing: 2px; color: var(--accent); text-transform: uppercase; margin-bottom: 10px; }
  .output-box {
    background: var(--card); border: 1px solid var(--accent); border-radius: var(--r);
    padding: 18px; font-family: 'JetBrains Mono', monospace; font-size: 12.5px;
    line-height: 1.85; white-space: pre-wrap; color: var(--text);
    box-shadow: 0 0 20px rgba(79,255,176,0.08);
  }
  .copy-btn {
    width: 100%; padding: 14px; background: transparent; border: 1.5px solid var(--accent);
    color: var(--accent); border-radius: var(--r); font-family: 'Space Grotesk', sans-serif;
    font-size: 14px; font-weight: 600; cursor: pointer; margin-top: 12px; transition: all 0.2s;
  }
  .copy-btn:hover { background: var(--accent-glow); }
  .copy-btn.done { color: var(--yellow); border-color: var(--yellow); }
  .reset-btn {
    width: 100%; padding: 12px; background: transparent; border: 1px solid var(--border);
    color: var(--muted); border-radius: var(--r); font-family: 'Space Grotesk', sans-serif;
    font-size: 13px; cursor: pointer; margin-top: 8px; transition: all 0.2s;
  }
  .reset-btn:hover { border-color: var(--red); color: var(--red); }

  .clear-data-btn {
    margin-top: 8px; padding: 10px; background: transparent;
    border: 1px solid rgba(255,77,109,0.3); color: rgba(255,77,109,0.7);
    border-radius: var(--r); font-size: 12px; cursor: pointer;
    width: 100%; transition: all 0.2s;
  }
  .clear-data-btn:hover { border-color: var(--red); color: var(--red); background: rgba(255,77,109,0.05); }
</style>
</head>
<body>

<div class="header">
  <div class="eyebrow">üßπ Asistente de Limpiezas</div>
  <h1>Breezeway <span>‚Üí Michelle</span></h1>
  <p>Con memoria autom√°tica ¬∑ feriados detectados</p>
</div>

<div style="padding:0 16px">
  <div class="steps" style="margin-top:20px">
    <div class="step active" id="s1"><span class="num">01</span><span class="lbl">Subir xlsx</span></div>
    <div class="step" id="s2"><span class="num">02</span><span class="lbl">Pagos</span></div>
    <div class="step" id="s3"><span class="num">03</span><span class="lbl">Copiar</span></div>
  </div>
</div>

<!-- Zona principal de carga (desktop / drag & drop) -->
<div class="upload-zone" id="uploadZone" ondragover="onDrag(event)" ondragleave="offDrag()" ondrop="onDrop(event)">
  <!-- SIN atributo accept ‚Üí iOS muestra TODOS los archivos en el explorador -->
  <input type="file" id="fileInput" onchange="handleFile(this.files[0])">
  <div class="ico">üìÇ</div>
  <h3>Sube el export de Breezeway</h3>
  <p>Toca aqu√≠ o arrastra el archivo</p>
  <div class="ios-tip">üì± iPhone: toca ‚Üí "Explorar" ‚Üí busca tu .xlsx en Archivos</div>
</div>

<!-- Bot√≥n alternativo grande ‚Äî m√°s fiable en Safari iOS -->
<label class="ios-file-btn" id="iosFileBtn">
  üìé Seleccionar archivo desde iPhone
  <!-- SIN accept para que iOS no filtre ni bloquee archivos -->
  <input type="file" id="fileInput2" onchange="handleFile(this.files[0])">
</label>

<button class="skip-btn" onclick="skipToData()">O presiona aqu√≠ si solo quieres generar el mensaje de hoy ‚Üí</button>

<div class="content">
  <div class="status-bar" id="statusBar">
    <div class="dot"></div>
    <span id="statusText">Procesando...</span>
  </div>

  <div class="info-box" id="infoBox" style="display:none">
    üíæ <strong>Datos guardados:</strong> <span id="savedDays">0</span> d√≠as de limpiezas + pagos en memoria.
  </div>

  <div class="holiday-alert" id="holidayAlert">
    <div class="ico">üáµüá¶</div>
    <div>
      <div class="title">Feriado en Panam√° esta semana ‚Äî +$20 aplicado</div>
      <div class="dates" id="holidayDates"></div>
    </div>
  </div>

  <div class="pay-section" id="paySection">
    <div class="sec-label">Estado de pagos por d√≠a</div>
    <p class="hint">Marca como <span style="color:var(--accent)">Pagado</span> e ingresa la fecha si ya se pag√≥.</p>
    <div class="day-pay-grid" id="dayPayGrid"></div>
    <div class="totals-box">
      <div class="total-row highlight">
        <span class="tl">üí∞ Total pendiente</span>
        <span class="tr" id="totalPend">$0</span>
      </div>
    </div>

    <div class="sec-label">Pagos anteriores realizados</div>
    <p class="hint">Pagos ya enviados (aparecen al final del mensaje).</p>
    <div id="prevPaysContainer"></div>
    <button class="add-prev-btn" onclick="addPrevPay()">+ Agregar pago anterior</button>

    <button class="gen-btn" onclick="generateMessage()">‚ú¶ Generar mensaje para Michelle</button>
  </div>

  <div class="output-section" id="outputSection">
    <div class="out-label">Mensaje listo para copiar üëá</div>
    <div class="output-box" id="outputBox"></div>
    <button class="copy-btn" id="copyBtn" onclick="copyMsg()">üìã Copiar mensaje</button>
    <button class="reset-btn" onclick="resetView()">‚Ü© Subir otro archivo</button>
    <button class="clear-data-btn" onclick="confirmClearData()">üóëÔ∏è Borrar todo el historial guardado</button>
  </div>
</div>

<script>
const DAYS = ['Domingo','Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado'];
const MONTHS = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
const RATES = { 'M-305B': 50, default: 40 };
const HOLIDAY_BONUS = 20;

const PANAMA_HOLIDAYS = new Set([
  '2025-01-01','2025-01-09','2025-03-04','2025-04-18',
  '2025-05-01','2025-11-03','2025-11-05','2025-11-10','2025-11-28',
  '2025-12-08','2025-12-20','2025-12-25',
  '2026-01-01','2026-01-09','2026-02-17','2026-04-03',
  '2026-05-01','2026-11-03','2026-11-05','2026-11-10','2026-11-28',
  '2026-12-08','2026-12-20','2026-12-21','2026-12-25',
]);

const HOLIDAY_NAMES = {
  '2026-02-17':'Martes de Carnaval','2025-03-04':'Martes de Carnaval',
  '2026-04-03':'Viernes Santo','2025-04-18':'Viernes Santo',
  '2026-05-01':'D√≠a del Trabajo','2025-05-01':'D√≠a del Trabajo',
  '2026-01-01':'A√±o Nuevo','2025-01-01':'A√±o Nuevo',
  '2026-01-09':'D√≠a de los M√°rtires','2025-01-09':'D√≠a de los M√°rtires',
  '2026-11-03':'Separaci√≥n de Colombia','2025-11-03':'Separaci√≥n de Colombia',
  '2026-11-05':'Uni√≥n de Col√≥n','2025-11-05':'Uni√≥n de Col√≥n',
  '2026-11-10':'Primer Grito de Independencia','2025-11-10':'Primer Grito de Independencia',
  '2026-11-28':'Independencia de Espa√±a','2025-11-28':'Independencia de Espa√±a',
  '2026-12-08':'D√≠a de la Madre','2025-12-08':'D√≠a de la Madre',
  '2026-12-20':'Duelo Nacional','2025-12-20':'Duelo Nacional',
  '2026-12-21':'D√≠a Puente',
  '2026-12-25':'Navidad','2025-12-25':'Navidad',
};

let allCleanings = {};
let dayPayState  = {};
let prevPays     = [];

// ‚îÄ‚îÄ Initial data ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadInitialData() {
  const initial = {
    '2026-02-09': [{unit:'02-505',type:'turnover'},{unit:'03-505',type:'turnover'}],
    '2026-02-10': [{unit:'06-703',type:'turnover'}],
    '2026-02-12': [{unit:'02-505',type:'turnover'},{unit:'03-505',type:'turnover'}],
    '2026-02-13': [{unit:'06-703',type:'turnover'},{unit:'M-305B',type:'turnover'}],
    '2026-02-14': [{unit:'03-505',type:'salida'}],
    '2026-02-15': [{unit:'06-703',type:'salida'}],
    '2026-02-16': [{unit:'02-505',type:'turnover'},{unit:'03-505',type:'turnover'}],
    '2026-02-17': [{unit:'06-703',type:'turnover'},{unit:'M-305B',type:'turnover'}],
    '2026-02-18': [{unit:'02-505',type:'salida'},{unit:'03-505',type:'turnover'}],
    '2026-02-19': [{unit:'06-703',type:'turnover'},{unit:'M-305B',type:'turnover'}],
    '2026-02-20': [{unit:'02-505',type:'ingreso'},{unit:'06-703',type:'turnover'},{unit:'M-305B',type:'turnover'}],
    '2026-02-21': [{unit:'03-505',type:'salida'}],
    '2026-02-22': [{unit:'02-505',type:'salida'},{unit:'06-703',type:'salida'},{unit:'M-305B',type:'salida'}],
  };
  const payData = {
    '2026-02-09': {status:'paid', paidDate:'13/02'},
    '2026-02-10': {status:'paid', paidDate:'13/02'},
    '2026-02-12': {status:'paid', paidDate:'13/02'},
    '2026-02-13': {status:'pending', paidDate:''},
    '2026-02-14': {status:'pending', paidDate:''},
    '2026-02-15': {status:'pending', paidDate:''},
    '2026-02-16': {status:'pending', paidDate:''},
    '2026-02-17': {status:'pending', paidDate:''},
    '2026-02-18': {status:'pending', paidDate:''},
    '2026-02-19': {status:'pending', paidDate:''},
    '2026-02-20': {status:'pending', paidDate:''},
    '2026-02-21': {status:'pending', paidDate:''},
    '2026-02-22': {status:'pending', paidDate:''},
  };
  const prevPayments = [
    {date:'02/02', amount:'210'},
    {date:'06/02', amount:'160'},
    {date:'10/02', amount:'210'},
    {date:'13/02', amount:'250'},
  ];
  return { cleanings: initial, payState: payData, prevPays: prevPayments };
}

// ‚îÄ‚îÄ Load from localStorage ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadData() {
  try {
    const saved = localStorage.getItem('breezewayData');
    let needsInit = false;
    if (saved) {
      const data = JSON.parse(saved);
      allCleanings = data.cleanings || {};
      dayPayState  = data.payState  || {};
      prevPays     = data.prevPays  || [];
      if (!allCleanings['2026-02-09']) needsInit = true;
    } else {
      needsInit = true;
    }
    if (needsInit) {
      const init = loadInitialData();
      Object.entries(init.cleanings).forEach(([k,v]) => { if (!allCleanings[k]) allCleanings[k] = v; });
      Object.entries(init.payState).forEach(([k,v])  => { if (!dayPayState[k])  dayPayState[k]  = v; });
      if (prevPays.length === 0) prevPays = init.prevPays;
      saveData();
    }
    if (Object.keys(allCleanings).length > 0) {
      document.getElementById('infoBox').style.display = 'block';
      document.getElementById('savedDays').textContent = Object.keys(allCleanings).length;
    }
  } catch (e) { console.error('Error loading data:', e); }
}

function saveData() {
  try {
    localStorage.setItem('breezewayData', JSON.stringify({ cleanings: allCleanings, payState: dayPayState, prevPays }));
  } catch (e) { console.error('Error saving data:', e); }
}

// ‚îÄ‚îÄ Drag & drop ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function onDrag(e)  { e.preventDefault(); document.getElementById('uploadZone').classList.add('drag'); }
function offDrag()  { document.getElementById('uploadZone').classList.remove('drag'); }
function onDrop(e)  { e.preventDefault(); offDrag(); if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]); }

// ‚îÄ‚îÄ Skip to data ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function skipToData() {
  if (Object.keys(allCleanings).length === 0) {
    alert('‚ö†Ô∏è No hay datos guardados a√∫n. Por favor sube un archivo primero.');
    return;
  }
  showStatus('‚úÖ Usando datos guardados');
  hideUploadUI();
  document.getElementById('paySection').classList.add('show');
  setStep(2);
  detectHolidays();
  renderDayPayRows();
  renderPrevPays();
}

function hideUploadUI() {
  document.getElementById('uploadZone').style.display = 'none';
  document.getElementById('iosFileBtn').style.display = 'none';
  document.querySelector('.skip-btn').style.display = 'none';
}

// ‚îÄ‚îÄ Normalizar nombre de unidad ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Convierte "2-505" ‚Üí "02-505", "3-505" ‚Üí "03-505", etc.
// Preserva "M-305B" y similares sin n√∫mero inicial
function normalizeUnit(raw) {
  const s = raw.trim();
  // Si empieza con d√≠gito(s) seguido de gui√≥n: normalizar a 2 d√≠gitos
  // Ej: "2-505" ‚Üí "02-505", "06-703" ‚Üí "06-703" (ya OK)
  return s.replace(/^(\d+)-/, (_, n) => n.padStart(2, '0') + '-');
}

// ‚îÄ‚îÄ File handling ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function handleFile(file) {
  if (!file) return;

  const name = file.name.toLowerCase();
  const isCSV = name.endsWith('.csv') || file.type === 'text/csv' || file.type === 'text/plain';

  showStatus('Leyendo archivo...');

  const reader = new FileReader();

  if (isCSV) {
    // Leer CSV como texto
    reader.onload = e => {
      try {
        const text = e.target.result;
        // Usar xlsx para parsear CSV tambi√©n
        const wb   = XLSX.read(text, { type: 'string', cellDates: true });
        const ws   = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws, { header: 1, raw: false });
        processRows(rows);
      } catch(err) {
        showStatus('‚ùå Error al leer CSV: ' + err.message);
        console.error(err);
      }
    };
    reader.onerror = () => showStatus('‚ùå No se pudo leer el archivo.');
    reader.readAsText(file, 'UTF-8');
  } else {
    // Leer como ArrayBuffer (xlsx/xls)
    reader.onload = e => {
      try {
        const wb   = XLSX.read(new Uint8Array(e.target.result), { type: 'array', cellDates: true });
        const ws   = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws, { header: 1, raw: false });
        processRows(rows);
      } catch(err) {
        showStatus('‚ùå Error al leer: ' + err.message);
        console.error(err);
      }
    };
    reader.onerror = () => showStatus('‚ùå No se pudo leer el archivo.');
    reader.readAsArrayBuffer(file);
  }
}

function processRows(rows) {
  try {
      const headers = rows[0];
      const COL = {};
      headers.forEach((h, i) => {
        const hc = (h || '').replace(/^\uFEFF/, '').trim(); // quitar BOM si existe
        if (hc === 'Department') COL.dept = i;
        if (hc === 'Property')   COL.prop = i;
        if (hc === 'Task title') COL.task = i;
        if (hc === 'Due date')   COL.due  = i;
      });

      const newData = {};
      for (let i = 1; i < rows.length; i++) {
        const r = rows[i];
        if (!r[COL.dept] || r[COL.dept] !== 'Cleaning') continue;
        const propRaw = (r[COL.prop] || '').trim();
        const prop    = normalizeUnit(propRaw); // ‚Üê normalizar aqu√≠
        const task    = (r[COL.task] || '').toLowerCase();
        const dueRaw  = r[COL.due];
        if (!dueRaw || !prop) continue;

        let key;
        if (typeof dueRaw === 'string') {
          const m = dueRaw.match(/(\d{4})-(\d{2})-(\d{2})/);
          if (m) key = `${m[1]}-${m[2]}-${m[3]}`; else continue;
        } else if (dueRaw instanceof Date) {
          key = dueRaw.toISOString().split('T')[0];
        } else continue;

        let type = 'salida';
        if (task.includes('turnover')) type = 'turnover';
        else if (task.includes('ingreso') && !task.includes('salida')) type = 'ingreso';

        if (!newData[key]) newData[key] = [];
        // Deduplicar: mismo d√≠a + mismo apto normalizado ‚Üí solo 1 limpieza
        // Si ya existe turnover, no agregar salida suelta (turnover incluye salida)
        const exists = newData[key].some(x => x.unit === prop);
        if (!exists) {
          newData[key].push({ unit: prop, type });
        } else if (type === 'turnover') {
          // Si viene turnover y ya hab√≠a salida, reemplazar por turnover
          const idx = newData[key].findIndex(x => x.unit === prop);
          newData[key][idx].type = 'turnover';
        }
      }

      // Merge con historial existente ‚Äî normalizando unidades del historial tambi√©n
      Object.entries(newData).forEach(([key, tasks]) => {
        if (!allCleanings[key]) allCleanings[key] = [];
        // Normalizar unidades ya guardadas en historial
        allCleanings[key] = allCleanings[key].map(x => ({ ...x, unit: normalizeUnit(x.unit) }));
        tasks.forEach(t => {
          const existsIdx = allCleanings[key].findIndex(x => x.unit === t.unit);
          if (existsIdx === -1) {
            allCleanings[key].push(t);
          } else if (t.type === 'turnover') {
            allCleanings[key][existsIdx].type = 'turnover';
          }
        });
      });

      const total = Object.values(allCleanings).flat().length;
      const days  = Object.keys(allCleanings).length;
      if (!total) { showStatus('‚ö†Ô∏è No se encontraron limpiezas en el archivo.'); return; }

      showStatus(`‚úÖ ${total} limpiezas en ${days} d√≠as (fusionado con historial)`);
      document.getElementById('infoBox').style.display = 'block';
      document.getElementById('savedDays').textContent = days;

      buildResumeDates().forEach(d => {
        const k = dKey(d);
        if (!dayPayState[k]) dayPayState[k] = { status: 'pending', paidDate: '' };
      });

      saveData();
      detectHolidays();
      hideUploadUI();
      document.getElementById('paySection').classList.add('show');
      setStep(2);
      renderDayPayRows();
      renderPrevPays();
  } catch(err) {
    showStatus('‚ùå Error al procesar: ' + err.message);
    console.error(err);
  }
}

// ‚îÄ‚îÄ Holiday detection ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function detectHolidays() {
  const found = [];
  buildResumeDates().forEach(d => {
    const k = dKey(d);
    if (PANAMA_HOLIDAYS.has(k) && (allCleanings[k] || []).filter(t => t.type !== 'ingreso').length > 0) {
      found.push({ key: k, date: d });
    }
  });
  const alertEl = document.getElementById('holidayAlert');
  if (found.length) {
    alertEl.classList.add('show');
    document.getElementById('holidayDates').textContent = found.map(h => {
      const d = h.date;
      return `${DAYS[d.getDay()]} ${d.getDate()} ${MONTHS[d.getMonth()]} ‚Äî ${HOLIDAY_NAMES[h.key] || 'Feriado'}`;
    }).join(' ¬∑ ');
  } else {
    alertEl.classList.remove('show');
  }
}

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function dKey(d)     { return d.toISOString().split('T')[0]; }
function today()     { const t = new Date(); t.setHours(12,0,0,0); return t; }
function addDays(d,n){ const r = new Date(d); r.setDate(r.getDate()+n); return r; }
function buildCalDates()    { return Array.from({length:8},  (_,i) => addDays(today(), i-1)); }
function buildResumeDates() { return Array.from({length:14}, (_,i) => addDays(today(), i-7)); }

function getDayRate(key) {
  const tasks = allCleanings[key] || [];
  const date = new Date(key + 'T12:00:00');
  const isWeekend = date.getDay() === 0 || date.getDay() === 6;
  const isHoliday = PANAMA_HOLIDAYS.has(key);
  let total = 0;
  tasks.forEach(u => {
    if (u.type === 'ingreso') return;
    total += (RATES[u.unit] || RATES.default) + ((isWeekend || isHoliday) ? HOLIDAY_BONUS : 0);
  });
  return total;
}

function showStatus(msg) {
  document.getElementById('statusBar').classList.add('show');
  document.getElementById('statusText').textContent = msg;
}

function setStep(n) {
  [1,2,3].forEach(i => {
    const el = document.getElementById(`s${i}`);
    el.classList.remove('active','done');
    if (i < n)   el.classList.add('done');
    if (i === n) el.classList.add('active');
  });
}

// ‚îÄ‚îÄ Render pay rows ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderDayPayRows() {
  const grid = document.getElementById('dayPayGrid');
  grid.innerHTML = '';
  const todayKey = dKey(today());
  let totalPending = 0;

  buildResumeDates().forEach(d => {
    const key      = dKey(d);
    const tasks    = allCleanings[key] || [];
    const billable = tasks.filter(t => t.type !== 'ingreso');
    if (!billable.length) return;

    const amt    = getDayRate(key);
    const state  = dayPayState[key] || { status: 'pending', paidDate: '' };
    const isPaid = state.status === 'paid';
    if (!isPaid) totalPending += amt;

    const isWeekend = d.getDay() === 0 || d.getDay() === 6;
    const holiday   = PANAMA_HOLIDAYS.has(key);
    const hasBonus  = isWeekend || holiday;
    const isToday   = key === todayKey;

    const row = document.createElement('div');
    row.className = 'day-pay-row' + (hasBonus ? ' has-holiday' : '');
    row.innerHTML = `
      <div class="day-info">
        <div class="day-pay-name">
          ${DAYS[d.getDay()]} ${d.getDate()} ${MONTHS[d.getMonth()]}
          ${isToday ? '<span class="today-badge">HOY</span>' : ''}
          ${holiday ? '<span class="holiday-badge">üáµüá¶ Feriado +$20</span>' : ''}
          ${isWeekend && !holiday ? '<span class="holiday-badge">Fin de semana +$20</span>' : ''}
        </div>
        <div class="day-pay-units">${billable.map(t=>t.unit).join(', ')}</div>
      </div>
      <div class="day-pay-amount">$${amt}</div>
      <div class="pay-status-toggle">
        <button class="${!isPaid?'active-pend':''}" onclick="setPayStatus('${key}','pending')">Pendiente</button>
        <button class="${isPaid?'active-paid':''}"  onclick="setPayStatus('${key}','paid')">Pagado</button>
      </div>
      <input class="paid-date-input ${isPaid?'show':''}" id="pdate-${key}"
        placeholder="13/02" value="${state.paidDate}"
        oninput="setPaidDate('${key}', this.value)">
    `;
    grid.appendChild(row);
  });

  document.getElementById('totalPend').textContent = `$${totalPending}`;
}

function setPayStatus(key, status) {
  if (!dayPayState[key]) dayPayState[key] = { status, paidDate: '' };
  dayPayState[key].status = status;
  saveData();
  renderDayPayRows();
}

function setPaidDate(key, val) {
  if (!dayPayState[key]) dayPayState[key] = { status: 'paid', paidDate: val };
  dayPayState[key].paidDate = val;
  saveData();
}

// ‚îÄ‚îÄ Prev payments ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function addPrevPay() { prevPays.push({ date:'', amount:'' }); saveData(); renderPrevPays(); }

function renderPrevPays() {
  const c = document.getElementById('prevPaysContainer');
  c.innerHTML = '';
  prevPays.forEach((p, i) => {
    const row = document.createElement('div');
    row.className = 'prev-pay-row';
    row.innerHTML = `
      <span style="color:var(--muted);font-size:12px;white-space:nowrap">Pagado</span>
      <input class="date-in" placeholder="02/02" value="${p.date}" oninput="prevPays[${i}].date=this.value;saveData()">
      <span style="color:var(--muted)">$</span>
      <input class="amt-in" placeholder="210" value="${p.amount}" oninput="prevPays[${i}].amount=this.value;saveData()">
      <button class="remove-btn" onclick="removePrevPay(${i})">√ó</button>
    `;
    c.appendChild(row);
  });
}
function removePrevPay(i) { prevPays.splice(i,1); saveData(); renderPrevPays(); }

// ‚îÄ‚îÄ Generate message ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function generateMessage() {
  let msg = 'Limpiezas:\n\n';

  buildCalDates().forEach(d => {
    const key   = dKey(d);
    const tasks = allCleanings[key] || [];
    msg += `${DAYS[d.getDay()]} ${d.getDate()} ${MONTHS[d.getMonth()]}:\n`;
    if (!tasks.length) {
      msg += 'N/A x el momento.  ';
    } else {
      tasks.forEach(t => {
        let line = `-${t.unit}: `;
        if      (t.type === 'turnover') line += 'salida (11am) e ingreso (3pm)**Limpiar';
        else if (t.type === 'ingreso')  line += 'ingreso (3pm)';
        else                            line += 'salida (11am)**Limpiar';
        msg += line + '\n';
      });
    }
    msg += '\n';
  });

  msg = msg.trimEnd() + '\n‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî\nResumen de Limpiezas:\n';
  buildResumeDates().forEach(d => {
    const key      = dKey(d);
    const tasks    = allCleanings[key] || [];
    const billable = tasks.filter(t => t.type !== 'ingreso');
    const state    = dayPayState[key] || { status:'pending', paidDate:'' };
    const amt      = getDayRate(key);
    const label    = `${DAYS[d.getDay()]} ${d.getDate()} ${MONTHS[d.getMonth()]}`;

    if (!billable.length) {
      msg += `-${label}: Sin limpiezas x el momento\n`;
    } else {
      const units = billable.map(t => t.unit).join(', ');
      if (state.status === 'paid' && state.paidDate) {
        msg += `-${label}: ${units} // pagado ${state.paidDate} $${amt}\n`;
      } else {
        msg += `-${label}: ${units} // Pendiente $${amt}\n`;
      }
    }
  });

  const totalPending = buildResumeDates().reduce((sum, d) => {
    const key = dKey(d);
    const billable = (allCleanings[key] || []).filter(t => t.type !== 'ingreso');
    const state = dayPayState[key] || { status: 'pending' };
    return (state.status !== 'paid' && billable.length) ? sum + getDayRate(key) : sum;
  }, 0);

  msg += '------------------------------------\n';
  msg += `Pendiente: $${totalPending}*\n`;
  prevPays.forEach(p => { if (p.date && p.amount) msg += `Pagado ${p.date}: $${p.amount}\n`; });

  document.getElementById('outputBox').textContent = msg.trim();
  document.getElementById('outputSection').classList.add('show');
  document.getElementById('outputSection').scrollIntoView({ behavior: 'smooth' });
  setStep(3);
}

// ‚îÄ‚îÄ Copy & reset ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function copyMsg() {
  navigator.clipboard.writeText(document.getElementById('outputBox').textContent).then(() => {
    const btn = document.getElementById('copyBtn');
    btn.textContent = '‚úì ¬°Copiado!';
    btn.classList.add('done');
    setTimeout(() => { btn.textContent = 'üìã Copiar mensaje'; btn.classList.remove('done'); }, 2500);
  });
}

function resetView() {
  document.getElementById('uploadZone').style.display = '';
  document.getElementById('iosFileBtn').style.display = '';
  document.querySelector('.skip-btn').style.display = '';
  document.getElementById('paySection').classList.remove('show');
  document.getElementById('outputSection').classList.remove('show');
  document.getElementById('statusBar').classList.remove('show');
  document.getElementById('holidayAlert').classList.remove('show');
  document.getElementById('fileInput').value  = '';
  document.getElementById('fileInput2').value = '';
  setStep(1);
}

function confirmClearData() {
  if (confirm('¬øSeguro que quieres borrar TODO el historial? Esto no se puede deshacer.')) {
    localStorage.removeItem('breezewayData');
    allCleanings = {}; dayPayState = {}; prevPays = [];
    document.getElementById('infoBox').style.display = 'none';
    alert('‚úÖ Historial borrado');
    resetView();
  }
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
loadData();
</script>
</body>
</html>
